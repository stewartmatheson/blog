
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Setting up Nginx to work with Rails, Capistrano and SSL. - stew(@)rtmatheson.com</title>
  <meta name="author" content="Stewart Matheson">

  
  <meta name="description" content="I need to set up a billing system. I want to run you though how to set up such a system on a server complete with SSL and nginx as its a rails &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://stewartmatheson.github.com/blog/2011/07/setting-up-nginx-to-work-with-rails-capistrano-and-ssl">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/blog/atom.xml" rel="alternate" title="stew(@)rtmatheson.com" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">stew(@)rtmatheson.com</a></h1>
  
    <h2>Thoughts on Rails, Ruby, and Javascript</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:stewartmatheson.github.com/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About Me</a></li>
  <li><a href="/resume">Resume</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Setting Up Nginx to Work With Rails, Capistrano and SSL.</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-29T00:00:00+10:00" pubdate data-updated="true">Jul 29<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I need to set up a billing system. I want to run you though how to set up such a system on a server complete with SSL and nginx as its a rails application we are deploying. I will be using a brand new install of Ubuntu however the ideas in this post should work with any server. First off lets set up our linux box</p>

<h3>Base Linux Setup</h3>

<p>After you log in the first time you want to change your root password.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>passwd
</span></code></pre></td></tr></table></div></figure>


<p>The system will prompt you to change the root password. Once you have done this then you can create a new user. You should NEVER log in with the root user.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>adduser username
</span></code></pre></td></tr></table></div></figure>


<p>This command will prompt you to enter details about the user your creating however you only really need to enter the password. This is the user that we will use from this stage on so we need to add it to sudoers. If the user is not a sudoer then we cant install/compile anything. Nor can we make changes to system settings. Open the sudoers file with your favorite editor and add the following line</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /etc/sudoers
</span><span class='line'><span class="c">## Add this line to the file</span>
</span><span class='line'>username <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span>       ALL
</span></code></pre></td></tr></table></div></figure>


<p>Where username is the name of the user you have just created. Great now we have done this we have a user account and we don&#8217;t need to worry about our root user any more. Log out and then log back in with the new user. You should be able to run sudo commands.</p>

<h3>SSH</h3>

<p>First lets set up SSH Keys. This allows us to log in to our server with out having to enter a password. This is such a time saver and worth setting up. Any time we are doing a deployment using capistrano we are going to be glad to have our SSH key in place. First off if you don&#8217;t have it create a .ssh folder in your home directory(on your local machine - not on the server). Windows users&#8230; sorry your on your own here. You might have to read the PuTTY doc.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir .ssh
</span></code></pre></td></tr></table></div></figure>


<p>After you have created the .ssh folder cd to it and run&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ssh-keygen -t rsa
</span></code></pre></td></tr></table></div></figure>


<p>This will create two files. One public and one private key. Never give out the private key. The public key can be given to anyone. In this case we are going to put the public key on our server. The public key is called id_rsa.pub.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>scp ~/.ssh/id_rsa.pub username@serveraddress
</span></code></pre></td></tr></table></div></figure>


<p>You will have to enter your password here. Once we have the key up there log back in to your server. You will still have to enter the password at this stage. You need to move the key file to a file called authorized_keys and set the ownership and permissions correctly on it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir .ssh
</span><span class='line'>mv id_rsa.pub .ssh/authorized_keys
</span><span class='line'>chown -R username:username .ssh/
</span><span class='line'>chmod 700 .ssh/
</span><span class='line'>chmod 600 .ssh/authorized_keys
</span></code></pre></td></tr></table></div></figure>


<p>Done! Logout and log back in. You should NOT be asked for a password. Once we have our keys set up there is one more thing that I would recommend doing at this stage. Changing the default SSH port. I always like  to use the same port so set it to something that you will remember. Write it down because if you can not remember the port number you may be locked out of your system. To change the port we need to edit the ssh config file. Do so like this&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo vim /etc/ssh/sshd_config
</span></code></pre></td></tr></table></div></figure>


<p>The port setting should be on the first line. Chagne it save the file. The settings will not take effect until you restart ssh.  At this point I would recommend you set up IP tables. While I am not going to talk about this in the first revision of this post I intend to add it later down the track when I have more time.</p>

<p>Now restart sshd</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/etc/init.d/ssh reload
</span></code></pre></td></tr></table></div></figure>


<p>When you login you should use the new port. Remember that ssh keys do not have any port information so you will still need to tell ssh what port we want to use as its no longer set to default.</p>

<h3>Install Ruby</h3>

<p>Once we have logged back in we need to install RVM. Ruby Version Manager is a great application that will help us manage ruby versions and gemsets. We can have many different gemsets and different versions of ruby. This allows us to serve applications from the same server in different ways.</p>

<p>First lets install some dependencies that RVM has.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install git-core curl build-essential vim libcurl4-openssl-dev
</span></code></pre></td></tr></table></div></figure>


<p>Next we run the remote script that will install and setup rvm for us</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>su
</span><span class='line'>user<span class="nv">$ </span>bash &lt; &lt;<span class="o">(</span>curl -s https://rvm.beginrescueend.com/install/rvm<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This script will use git to download RVM and install it. Note how we changed to the super user. This is because we want RVM multisite install. This is best for when we are installing RVM on servers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">type </span>rvm | head -1
</span></code></pre></td></tr></table></div></figure>


<p>This should output the string &#8220;rvm is a function&#8221;. If so then we are in business and rvm has been installed.</p>

<p>We still have not installed ruby. Ruby its self has a number of dependencies. Lets install them first. The package names may differ from distro to distro so you might want to double check what all of them are. They should work for ubuntu though.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install build-essential bison openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf
</span></code></pre></td></tr></table></div></figure>


<p>Currently we only have sqlite. If you want to use mysql run the following line.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install mysql-server libmysqlclient-dev libmysql-ruby
</span></code></pre></td></tr></table></div></figure>


<p>Now lets use RVM to install some packages for ruby.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm pkg install zlib
</span><span class='line'>rvm pkg install openssl
</span><span class='line'>rvm pkg install readline
</span></code></pre></td></tr></table></div></figure>


<p>Now we can install ruby 1.9.2</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm install 1.9.2 --with-zlib-dir<span class="o">=</span><span class="nv">$rvm_path</span>/usr --with-openssl-dir<span class="o">=</span><span class="nv">$rvm_path</span>/usr --with-readline-dir<span class="o">=</span><span class="nv">$rvm_path</span>/usr
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to install bundler and passenger so we need to create a gem set. Gemsets are logical groups of gems. I normally go one gem set per application.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm gemset create application_name
</span></code></pre></td></tr></table></div></figure>


<p>Now install bundler. This is how rails will manage the gems it needs.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install bundler
</span></code></pre></td></tr></table></div></figure>


<p>OK now we have ruby installed lets install the passenger gem. This makes live so easy as it will configure and compile nginx for us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install passenger
</span></code></pre></td></tr></table></div></figure>


<p>Once we have the gem installed we have access to some VERY helpful commands. passenger-install-nginx-module is the one we are going to run. This will install passenger for us and better yet it will go ahead and compile nginx for us too. All the time checking for any software that nginx might need. Very handy. I will not guide you though this process aside from running the command because the Phusion guys have created an amazing easy to use installer. To start the installer run</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvmsudo passenger-install-nginx-module
</span></code></pre></td></tr></table></div></figure>


<p>Once we are complete nginx will be installed with passenger and our webserver will be set up. Phusion even include the SSL module for Nginx which is great because we will need to use it for our credit card gateway. Incase you missed it nginx also gives you a configuration snippet. Incase you missed it here it is.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>    listen 80;
</span><span class='line'>    server_name www.yourhost.com;
</span><span class='line'>    root /somewhere/public;   <span class="c"># &lt;--- be sure to point to &#39;public&#39;!                                                       </span>
</span><span class='line'>    passenger_enabled on;
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will keep this handy as we will need it for our rails application when we set it up. Now we have everything installed we need to get a rails application on our server. I am going to assume you already have an application and that you are ready for deployment.</p>

<h3>Deploying The Application</h3>

<p>We will use capistrano to manage the deployment of the application. Lets log out of our server and go back to our application so we can install the capistrano gem locally. I will assume that your using RVM on your development machine and have not already got cap installed</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install capistrano
</span></code></pre></td></tr></table></div></figure>


<p>With the gem installed lets &#8220;capify&#8221; our project. Make sure your in your current project directory and run the following command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>capify .
</span></code></pre></td></tr></table></div></figure>


<p>This should create a couple of files but the one we are interested in is deploy.rb. This file holds all of the details that cap needs to deploy the application to our server. It also gives us a place to write any extra tasks that might need to be performed on our application.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;./lib&#39;</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;rvm_path&#39;</span><span class="o">]</span><span class="p">))</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;rvm/capistrano&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;bundler/capistrano&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rvm_ruby_string</span><span class="p">,</span> <span class="s1">&#39;1.9.2@gemset&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rvm_bin_path</span><span class="p">,</span> <span class="s2">&quot;/usr/local/rvm/bin&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code tells cap what gem set we want or application to useon the server. It also tells cap that we are working with a single user install of RVM. Cap has a number of other details that need to be set for the deployment to work correctly. These include user names and server addresses. At this stage I like to add some tasks to my cap deploy file. These are&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Create database yaml in shared path&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:default</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">db_config</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">new</span> <span class="o">&lt;&lt;-</span><span class="no">EOF</span>
</span><span class='line'><span class="sh">    base: &amp;base</span>
</span><span class='line'><span class="sh">      adapter: mysql</span>
</span><span class='line'><span class="sh">      username: username</span>
</span><span class='line'><span class="sh">      password: password</span>
</span><span class='line'>
</span><span class='line'><span class="sh">    development:</span>
</span><span class='line'><span class="sh">      database: #{application}_dev</span>
</span><span class='line'><span class="sh">      &lt;&lt;: *base</span>
</span><span class='line'>
</span><span class='line'><span class="sh">    test:</span>
</span><span class='line'><span class="sh">      database: #{application}_test</span>
</span><span class='line'><span class="sh">      &lt;&lt;: *base</span>
</span><span class='line'>
</span><span class='line'><span class="sh">    production:</span>
</span><span class='line'><span class="sh">      database: #{application}_production</span>
</span><span class='line'><span class="sh">      &lt;&lt;: *base</span>
</span><span class='line'><span class="no">    EOF</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config&quot;</span>
</span><span class='line'>    <span class="n">put</span> <span class="n">db_config</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/database.yml&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Make symlink for database yaml&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:symlink</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/database.yml </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/database.yml&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:rvm</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Create correct RVM file&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:create_rvmrc</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; rvm use 1.9.2@</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2"> --rvmrc --create&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">before</span> <span class="s2">&quot;deploy:setup&quot;</span><span class="p">,</span> <span class="ss">:db</span>
</span><span class='line'><span class="n">after</span> <span class="s2">&quot;deploy:update_code&quot;</span><span class="p">,</span> <span class="s2">&quot;db:symlink&quot;</span>
</span><span class='line'><span class="n">after</span> <span class="s2">&quot;deploy:symlink&quot;</span><span class="p">,</span> <span class="s2">&quot;rvm:create_rvmrc&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above tasks manage our database configuration and create the correct RVM file. They are very handy as they completely automate the install on the server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cap deploy:setup
</span></code></pre></td></tr></table></div></figure>


<p>This will login to the server and create all the folders. This is where our rails application will be set up on our server. Note how we don&#8217;t have to enter a password. SSH keys are great when dealing with cap because entering a password for each deployment gets old quickly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cap deploy:check
</span></code></pre></td></tr></table></div></figure>


<p>Cap will go ahead and make sure your server has correct permissions to deploy your application. It will also check for any needed software such as source control managers. Once this is done and works then we are ready to deploy our application. Next lets deploy our application</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cap deploy
</span></code></pre></td></tr></table></div></figure>


<p>This will install the application on the server in the deploy_to path. It will also create a number of symlinks. Its a great way of deploying an application because if something goes wrong it will roll back to the last version. Since this is the first time that we have deployed this does not apply to us. Now lets set up the database.yml file on our server. This is done with the &#8220;db&#8221; cap task.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cap db
</span></code></pre></td></tr></table></div></figure>


<p>Run another cap deploy after this and the database file will correctly link to the application. The next thing to do is create a database for the application and a database user.  In the cap task make sure you replace username and password with the user account we are about to set up in mysql. Remember these can be any username and password you like. Just remember that the username and password in the database.yml file need to match what has been created in mysql. To create the user and pass in mysql do the following</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">application_name_production</span><span class="p">;</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">&#39;username&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">&#39;password&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="n">application_name_production</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">&#39;username&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span>
</span><span class='line'><span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Basic overview on SSL</h3>

<p>SSL uses private key authentication to verify that a site is who it claims to be. This is done by matching up keys. Much the same way as installing SSH keys works. To do this we generate our own private key. This is super secret! We do this on our server and it stays on the server. It is a security risk taking it off the server as you will have to transfer it over a network(this is unless you have physical access to your server). With this private key we create a certificate signing request. This CSR is then given to our SSL provider. Based on the CSR your SSL provider will create a certificate and send it back to you. They might do this via email as there is no risk if your certificate is out in the open. This certificate will only match the private key that we have on our server meaning that there is only one server that the certificate will match. Your SSL provider should have information available on how to prepare the certificate for use with Nginx as most people will most likely be running Apache(poor fools). One you have th crt file ready to go we point Nginx at that file and the private key we generated. The server will match the two up and users will be safe sending their credit card details via https.</p>

<h3>Configuring Nginx with SSL</h3>

<p>Okay so we have everything installed. We have our application deployed. We have our application settings correct (we think&#8230; time will tell). The next thing to do is configure nginx to pick up on our rails application and work over SSL. Remember the code snippet we got when we installed nginx. Place that in your nginx config file with some changes. Here is the code snippet set up to work for SSL.</p>

<p>Open nginx.conf</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /opt/nginx/conf/nginx.conf
</span></code></pre></td></tr></table></div></figure>


<p>Add our server configuration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>        listen 443;
</span><span class='line'>        server_name domain.com;
</span><span class='line'>        root /where/your/app/is;
</span><span class='line'>        passenger_enabled on;
</span><span class='line'>        ssl on;
</span><span class='line'>        ssl_certificate /path/to/server.crt;
</span><span class='line'>        ssl_certificate_key /path/to/server.key;
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the ssl configuration is pointing at two files. A certificate and a key. For this setup we will generate the certificate and sign it our selves. This will NOT do in production as it will show users that the certificate is not trusted however for now its fine.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /path/to/ssl/certs
</span><span class='line'>openssl genrsa -des3 -out server.key 1024
</span><span class='line'>openssl req -new -key server.key -out server.csr
</span><span class='line'>cp server.key server.key.org
</span><span class='line'>openssl rsa -in server.key.org -out server.key
</span><span class='line'>openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
</span></code></pre></td></tr></table></div></figure>


<p>OK now we have nginx all ready to go lets create our init script. The init script allows us to stop and start nginx when we need to and its not provided for us when we install nginx via passenger.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo vim /etc/init.d/nginx
</span></code></pre></td></tr></table></div></figure>


<p>Add the following to this file and save.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="c">### BEGIN INIT INFO</span>
</span><span class='line'><span class="c"># Provides:          nginx</span>
</span><span class='line'><span class="c"># Required-Start:    $all</span>
</span><span class='line'><span class="c"># Required-Stop:     $all</span>
</span><span class='line'><span class="c"># Default-Start:     2 3 4 5</span>
</span><span class='line'><span class="c"># Default-Stop:      0 1 6</span>
</span><span class='line'><span class="c"># Short-Description: starts the nginx web server</span>
</span><span class='line'><span class="c"># Description:       starts nginx using start-stop-daemon</span>
</span><span class='line'><span class="c">### END INIT INFO</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
</span><span class='line'><span class="nv">DAEMON</span><span class="o">=</span>/usr/local/sbin/nginx
</span><span class='line'><span class="nv">NAME</span><span class="o">=</span>nginx
</span><span class='line'><span class="nv">DESC</span><span class="o">=</span>nginx
</span><span class='line'>
</span><span class='line'><span class="nb">test</span> -x <span class="nv">$DAEMON</span> <span class="o">||</span> <span class="nb">exit </span>0
</span><span class='line'>
</span><span class='line'><span class="c"># Include nginx defaults if available</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f /etc/default/nginx <span class="o">]</span> ; <span class="k">then</span>
</span><span class='line'>        . /etc/default/nginx
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
</span><span class='line'>  start<span class="o">)</span>
</span><span class='line'>        <span class="nb">echo</span> -n <span class="s2">&quot;Starting $DESC: &quot;</span>
</span><span class='line'>        start-stop-daemon --start --quiet --pidfile /usr/local/nginx/logs/<span class="nv">$NAME</span>.pid <span class="se">\</span>
</span><span class='line'>                --exec <span class="nv">$DAEMON</span> -- <span class="nv">$DAEMON_OPTS</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;$NAME.&quot;</span>
</span><span class='line'>        ;;
</span><span class='line'>  stop<span class="o">)</span>
</span><span class='line'>        <span class="nb">echo</span> -n <span class="s2">&quot;Stopping $DESC: &quot;</span>
</span><span class='line'>        start-stop-daemon --stop --quiet --pidfile /usr/local/nginx/logs/<span class="nv">$NAME</span>.pid <span class="se">\</span>
</span><span class='line'>                --exec <span class="nv">$DAEMON</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;$NAME.&quot;</span>
</span><span class='line'>        ;;
</span><span class='line'>  restart|force-reload<span class="o">)</span>
</span><span class='line'>        <span class="nb">echo</span> -n <span class="s2">&quot;Restarting $DESC: &quot;</span>
</span><span class='line'>        start-stop-daemon --stop --quiet --pidfile <span class="se">\</span>
</span><span class='line'>                /usr/local/nginx/logs/<span class="nv">$NAME</span>.pid --exec <span class="nv">$DAEMON</span>
</span><span class='line'>        sleep 1
</span><span class='line'>        start-stop-daemon --start --quiet --pidfile <span class="se">\</span>
</span><span class='line'>                /usr/local/nginx/logs/<span class="nv">$NAME</span>.pid --exec <span class="nv">$DAEMON</span> -- <span class="nv">$DAEMON_OPTS</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;$NAME.&quot;</span>
</span><span class='line'>        ;;
</span><span class='line'>  reload<span class="o">)</span>
</span><span class='line'>      <span class="nb">echo</span> -n <span class="s2">&quot;Reloading $DESC configuration: &quot;</span>
</span><span class='line'>      start-stop-daemon --stop --signal HUP --quiet --pidfile /usr/local/nginx/logs/<span class="nv">$NAME</span>.pid <span class="se">\</span>
</span><span class='line'>          --exec <span class="nv">$DAEMON</span>
</span><span class='line'>      <span class="nb">echo</span> <span class="s2">&quot;$NAME.&quot;</span>
</span><span class='line'>      ;;
</span><span class='line'>  *<span class="o">)</span>
</span><span class='line'>        <span class="nv">N</span><span class="o">=</span>/etc/init.d/<span class="nv">$NAME</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Usage: $N {start|stop|restart|force-reload}&quot;</span> &gt;&amp;2
</span><span class='line'>        <span class="nb">exit </span>1
</span><span class='line'>        ;;
</span><span class='line'><span class="k">esac</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exit </span>0
</span></code></pre></td></tr></table></div></figure>


<p>Now we have everything set up lets start nginx.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo /etc/init.d/nginx start
</span></code></pre></td></tr></table></div></figure>


<p>Once this is started point your browser to the correct domain via https and test your site out. Good luck!</p>

<h3>Sources</h3>

<p><a href="http://articles.slicehost.com/2010/10/18/ubuntu-maverick-setup-part-1">http://articles.slicehost.com/2010/10/18/ubuntu-maverick-setup-part-1</a></p>

<p><a href="http://articles.slicehost.com/2007/12/19/ubuntu-gutsy-nginx-ssl-and-vhosts">http://articles.slicehost.com/2007/12/19/ubuntu-gutsy-nginx-ssl-and-vhosts</a></p>

<p><a href="http://www.modrails.com/install.html">http://www.modrails.com/install.html</a></p>

<p><a href="http://blog.bigrocksoftware.com/2011/01/07/rvm-nginx-passenger-rails-3/">http://blog.bigrocksoftware.com/2011/01/07/rvm-nginx-passenger-rails-3/</a></p>

<p><a href="https://rvm.beginrescueend.com/rvm/install/">https://rvm.beginrescueend.com/rvm/install/</a></p>

<p><a href="http://excid3.com/blog/ruby-on-rails-3-and-mysql-on-ubuntu-10-10/">http://excid3.com/blog/ruby-on-rails-3-and-mysql-on-ubuntu-10-10/</a></p>

<p><a href="http://stackoverflow.com/questions/3644897/rvm-cannot-use-ruby-with-sudo">http://stackoverflow.com/questions/3644897/rvm-cannot-use-ruby-with-sudo</a></p>

<p><a href="http://help.github.com/deploy-with-capistrano/">http://help.github.com/deploy-with-capistrano/</a></p>

<p><a href="http://beginrescueend.com/integration/capistrano/">http://beginrescueend.com/integration/capistrano/</a></p>

<p><a href="http://blog.ninjahideout.com/posts/a-guide-to-a-nginx-passenger-and-rvm-server">http://blog.ninjahideout.com/posts/a-guide-to-a-nginx-passenger-and-rvm-server</a></p>

<p><a href="http://blog.ninjahideout.com/posts/the-path-to-better-rvm-and-passenger-integration">http://blog.ninjahideout.com/posts/the-path-to-better-rvm-and-passenger-integration</a></p>

<p><a href="http://stackoverflow.com/questions/4349628/rails-3-app-deployment-bundler-rake-issues">http://stackoverflow.com/questions/4349628/rails-3-app-deployment-bundler-rake-issues</a></p>

<p><a href="http://wiki.nginx.org/HttpSslModule">http://wiki.nginx.org/HttpSslModule</a></p>

<h3>Post updates</h3>

<p>23/08/2011 Added links to sources, added intro to ssl.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Stewart Matheson</span></span>

      








  


<time datetime="2011-07-29T00:00:00+10:00" pubdate data-updated="true">Jul 29<span>th</span>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://stewartmatheson.github.com/blog/2011/07/setting-up-nginx-to-work-with-rails-capistrano-and-ssl/" data-via="stewartmatheson" data-counturl="http://stewartmatheson.github.com/blog/2011/07/setting-up-nginx-to-work-with-rails-capistrano-and-ssl/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2011/06/new-theme/" title="Previous Post: New theme">&laquo; New theme</a>
      
      
        <a class="basic-alignment right" href="/2011/09/installing-ruby-1-9-2-on-mac-os-x-10-7-lion/" title="Next Post: Installing Ruby 1.9.2 on Mac os x 10.7 (Lion)">Installing Ruby 1.9.2 on Mac os x 10.7 (Lion) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("stewartmatheson", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/stewartmatheson" class="twitter-follow-button" data-show-count="false">Follow @stewartmatheson</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Stewart Matheson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'rtmatheson';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
